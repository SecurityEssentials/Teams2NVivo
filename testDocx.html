<!-- open -a 'Google Chrome' --args -allow-file-access-from-files -->
<body>
    <button onclick="gettext()">Get document text</button>
</body>
<script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
<script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip-utils.js"></script>
<script>
function str2xml(str) {
    if (str.charCodeAt(0) === 65279) {
        // BOM sequence
        str = str.substr(1);
    }
    return new DOMParser().parseFromString(str, "text/xml");
}

// Will use https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL
function loadFile(url, callback) {
        PizZipUtils.getBinaryContent(url, callback);
    }

function getParagraphs(content) {
    const zip = new PizZip(content);
    const xml = str2xml(zip.files["word/document.xml"].asText());
    const paragraphsXml = xml.getElementsByTagName("w:p");
    let fullText = "Timespan\tSpeaker\tContent\n";

    // First 3 paras are "Transcript\n 13 March 2024\nXXX started transcription\n
    // We'll ignore all short paragraphs anyway.
    for (let i = 0; i < paragraphsXml.length; i++) {
        const textsXml = Array.from(paragraphsXml[i].querySelectorAll("t, br"));
        // Gives br, t (Speaker), t (Timestamp), br  ... followed by content t and br elements.
        // Want Timestamp\tSpeaker\tContent---Content Content...
        fullText += (textsXml.length < 5) ? "" :         // Ignore short lines
            textsXml[2].childNodes[0].nodeValue + "\t"   // Timestamp
            + textsXml[1].childNodes[0].nodeValue + "\t" // Speaker
            + textsXml.slice(4).map(                     // Content
                    node => node.tagName.includes("br")
                          ? "---" : node.childNodes[0].nodeValue + " ")
                .join('')
                .trimEnd() // Don't want last space.
            + "\n";
    }
    return fullText;
}

    function gettext() {
        loadFile(
            "Example.docx",
            function (error, content) {
                if (error) {
                    throw error;
                }
                
                var text = getParagraphs(content);
                console.log(text);
                alert(text);
            }
        );
    }
</script>

